#!/usr/bin/expect -f
#
#  WC (FED) <----> WED (SED)
#

log_file test.log
source "tests/scripts/expect/_common.exp"
source "tests/scripts/expect/_multinode.exp"

set WC  1
set WED 2
set WAKEUP_ID "dead0000beef0000cafe"

send_user "\n\n>>> setup WED (SED)\n"
spawn_node $WED

setup_default_network

send "mode -\n"
expect_line "Done"

send "extaddr deadbeefcafe0002\n"
expect_line "Done"

send "pollperiod 2500\n"
expect "Done"

send "wakeup channel 11\n"
expect_line "Done"

send "wakeup parameters 1000000 8000\n"
expect_line "Done"

send "wakeup wakeupid add $WAKEUP_ID\n"
expect_line "Done"

send "ifconfig up\n"
expect_line "Done"

send "thread start\n"
expect_line "Done"

send "ipaddr\n"
expect_line "Done"

send "wakeup listen enable\n"
expect_line "Done"

set wed_link_local_addr [get_ipaddr linklocal]
send "srp client host name wed\n"
expect_line "Done"

send "srp client host address $wed_link_local_addr\n"
expect_line "Done"

send "srp client service add ins1 _matter._tcp 5540\n"
expect_line "Done"


send_user "\n\n>>> setup WC (FED)\n"
spawn_node $WC
setup_default_network

send "mode rdn\n"
expect_line "Done"

send "extaddr deadbeefcafe0001\n"
expect_line "Done"

send "routereligible disable\n"
expect_line "Done"

send "wakeup channel 11\n"
expect_line "Done"

send "ifconfig up\n"
expect_line "Done"

send "thread start\n"
expect_line "Done"

set wc_link_local_addr [get_ipaddr linklocal]

send_user "\n\n>>> WC wakes up WED\n"
send "wakeup wake $WAKEUP_ID 7500 1090\n"
expect_line "Done"

send "srp server addrmode anycast\n"
expect_line "Done"

send "srp server enable\n"
expect_line "Done"

send "srp server state\n"
expect_line "Done"

send "ping $wed_link_local_addr\n"
expect_line "Done"

sleep 1

send_user "\n\n>>> setup WED (SED)\n"

switch_node $WED

send "ipaddr\n"
expect_line "Done"

send "ping $wc_link_local_addr\n"
expect_line "Done"

sleep 5

send "srp client start $wc_link_local_addr 53\n"
expect_line "Done"

sleep 10

send_user "\n\n>>> setup WC (FED)\n"
switch_node $WC

send "srp server state\n"
expect_line "Done"

send "srp server host\n"
expect_line "Done"

interact
